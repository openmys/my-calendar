name: Release to NPM

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'ë°°í¬í•  ë²„ì „ (ì˜ˆ: 1.0.0, 1.0.1-beta.0)'
        required: true
        type: string
      tag:
        description: 'NPM íƒœê·¸ (latest, beta, alpha)'
        required: true
        type: choice
        options:
          - latest
          - beta
          - alpha
        default: latest

jobs:
  release:
    name: NPM ë°°í¬
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: write
      packages: write

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Corepack í™œì„±í™”
        run: corepack enable

      - name: pnpm ì„¤ì •
        uses: pnpm/action-setup@v2
        with:
          version: 10

      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          registry-url: 'https://npm.pkg.github.com'

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: pnpm install

      - name: í’ˆì§ˆ ê²€ì‚¬
        run: |
          pnpm run type-check
          pnpm run lint
          pnpm run test

      - name: ë²„ì „ ì—…ë°ì´íŠ¸
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          npm version ${{ inputs.version }} --no-git-tag-version
          git add package.json
          git commit -m "chore: bump version to ${{ inputs.version }}" || echo "ë²„ì „ ë³€ê²½ì‚¬í•­ ì—†ìŒ"

      - name: í”„ë¡œë•ì…˜ ë¹Œë“œ
        run: pnpm run build:prod

      - name: NPM ë°°í¬
        run: npm publish --tag ${{ inputs.tag }}
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: ë³€ê²½ì‚¬í•­ í‘¸ì‹œ
        run: |
          git push origin main || echo "í‘¸ì‹œí•  ë³€ê²½ì‚¬í•­ ì—†ìŒ"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Git íƒœê·¸ ìƒì„±
        run: |
          git tag v${{ inputs.version }}
          git push origin v${{ inputs.version }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: GitHub Release ìƒì„±
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ inputs.version }}
          release_name: Release v${{ inputs.version }}
          body: |
            ## ğŸ“¦ ë²„ì „ ${{ inputs.version }} ë°°í¬
            
            ì´ ë¦´ë¦¬ìŠ¤ëŠ” GitHub Actionsë¥¼ í†µí•´ ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.
            
            ### ë³€ê²½ ì‚¬í•­
            - ìì„¸í•œ ë³€ê²½ ì‚¬í•­ì€ ì»¤ë°‹ íˆìŠ¤í† ë¦¬ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.
            
            ### ì„¤ì¹˜ ë°©ë²•
            ```bash
            npm install @openmys/my-calendar@${{ inputs.version }}
            # ë˜ëŠ”
            pnpm add @openmys/my-calendar@${{ inputs.version }}
            ```
          draft: false
          prerelease: ${{ inputs.tag != 'latest' }}